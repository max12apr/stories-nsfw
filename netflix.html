<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OBSIDIAN – Netflix of Forbidden Stories</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: { netflix: '#e50914', dark: '#141414', gold: '#c6a15b' },
      fontFamily: { serif: ['Playfair Display','serif'], body: ['Inter','sans-serif'] }
    }
  }
}
</script>
<style>
.no-scrollbar::-webkit-scrollbar { display: none; }
.no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
.card { transition: transform 0.4s ease, box-shadow 0.4s ease; }
.card:hover { transform: scale(1.06); box-shadow: 0 10px 30px rgba(0,0,0,0.7); }
.card-overlay { background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%); }
@media (hover: none) { .card-overlay { opacity: 1 !important; } }
button { transition: all 0.2s ease; }
</style>
</head>
<body class="bg-dark text-white font-body min-h-screen">

<!-- AGE GATE -->
<div id="ageGate" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90">
  <div class="bg-dark p-10 rounded-xl text-center border border-white/20 max-w-md w-11/12 shadow-2xl">
    <h2 class="text-3xl mb-4 font-serif">Private Library</h2>
    <p class="text-gray-400 mb-8">This content contains mature themes. You must be 18+ to enter.</p>
    <button id="enterBtn" class="bg-netflix hover:bg-red-700 px-10 py-4 rounded font-bold text-lg transition">Enter</button>
  </div>
</div>

<!-- NAVBAR -->
<header class="fixed top-0 left-0 right-0 z-40 bg-black/90 backdrop-blur-md">
  <div class="flex items-center justify-between px-6 md:px-12 py-5">
    <div class="text-netflix font-bold text-3xl font-serif tracking-tight">OBSIDIAN</div>
    <nav class="hidden md:flex gap-8 text-sm font-medium">
      <a href="#" class="hover:text-gray-200 transition">Home</a>
      <a href="#" class="hover:text-gray-200 transition">Stories</a>
      <a href="#" class="hover:text-gray-200 transition">My List</a>
    </nav>
  </div>
</header>

<!-- HERO -->
<section class="relative h-[70vh] md:h-[85vh] mt-16">
  <video id="heroVideo" autoplay muted loop playsinline class="absolute inset-0 w-full h-full object-cover opacity-70"></video>
  <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
  <div class="relative z-10 px-6 md:px-16 pt-24 md:pt-40 max-w-3xl">
    <h1 id="heroTitle" class="text-4xl md:text-6xl font-bold mb-4 font-serif leading-tight">Loading Story...</h1>
    <p id="heroSubtitle" class="text-lg md:text-xl text-gray-300 mb-8 max-w-2xl">Please wait</p>
    <div class="flex flex-wrap gap-4">
      <button id="heroPlayBtn" class="bg-white hover:bg-gray-200 text-black px-8 py-3 md:py-4 rounded font-bold text-lg flex items-center gap-3 transition">
        ▶ Read
      </button>
      <button class="bg-gray-700/60 hover:bg-gray-600/80 px-8 py-3 md:py-4 rounded font-bold text-lg border border-gray-500 transition">
        + My List
      </button>
    </div>
  </div>
</section>

<!-- LIBRARY ROWS -->
<section id="library" class="px-6 md:px-16 py-12 space-y-12"></section>

<!-- STORY PLAYER MODAL -->
<div id="player" class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center p-4">
  <div class="bg-dark rounded-2xl flex flex-col md:flex-row w-full max-w-7xl h-[90vh] shadow-2xl overflow-hidden border border-gray-800">
    <!-- LEFT: Characters Side Panel -->
    <div id="characterPanel" class="w-full md:w-1/4 bg-gray-950 p-6 overflow-y-auto border-b md:border-b-0 md:border-r border-gray-800">
      <h3 class="text-2xl font-serif mb-6 text-gold">Characters</h3>
      <!-- Dynamic content -->
    </div>
    <!-- RIGHT: Story -->
    <div class="relative flex-1 p-6 md:p-10 overflow-hidden flex flex-col">
      <button onclick="closePlayer()" class="absolute top-4 right-4 md:top-6 md:right-8 text-4xl text-gray-400 hover:text-white z-30 transition">×</button>
      <video id="playerVideo" autoplay muted loop playsinline class="absolute inset-0 w-full h-full object-cover opacity-20 z-0"></video>
      <div class="relative z-10 overflow-y-auto flex-1 pr-2 custom-scroll">
        <h2 id="playerTitle" class="text-3xl md:text-4xl font-serif mb-6 leading-tight"></h2>
        <div id="playerContent" class="space-y-6 text-gray-200 leading-relaxed text-lg"></div>
      </div>
      <div class="mt-6 pt-4 border-t border-gray-800">
        <button onclick="shareReddit()" class="bg-netflix hover:bg-red-700 px-6 py-3 rounded font-semibold transition">Share on Reddit</button>
      </div>
    </div>
  </div>
</div>

<script>
// ────────────────────────────────────────────────
// GLOBAL STATE
// ────────────────────────────────────────────────
let stories = [];
let currentStoryId = null;

// ────────────────────────────────────────────────
// LOAD DATA FROM stories.json
// ────────────────────────────────────────────────
async function loadStories() {
  try {
    const response = await fetch('storiesgrok.json');
    if (!response.ok) throw new Error(`HTTP error ${response.status}`);
    stories = await response.json();

    // Optional: sort newest first (assuming id is numeric)
    stories.sort((a, b) => Number(b.id) - Number(a.id));

    buildLibrary();
    if (stories.length > 0) {
      setHeroStory(stories[0]);
    }
  } catch (err) {
    console.error("Failed to load stories.json:", err);
    document.getElementById('library').innerHTML = 
      '<p class="text-red-500 text-center text-xl py-10">Error loading stories. Please check if stories.json exists and is valid JSON.</p>';
  }
}

function setHeroStory(story) {
  if (!story) return;
  currentStoryId = story.id;
  document.getElementById('heroTitle').textContent = story.title;
  document.getElementById('heroSubtitle').textContent = story.subtitle || story.tldr || '';

  const hv = document.getElementById('heroVideo');
  if (story.heroVideo) {
    hv.src = story.heroVideo;
    hv.load();
    hv.play().catch(() => {});
  }
}

// ────────────────────────────────────────────────
// CONTINUE READING
// ────────────────────────────────────────────────
function getContinueReading() {
  try { return JSON.parse(localStorage.getItem('continueReading') || '[]'); } 
  catch { return []; }
}

function addToContinueReading(id) {
  let list = getContinueReading();
  list = list.filter(x => x !== id);
  list.unshift(id);
  if (list.length > 10) list.pop();
  localStorage.setItem('continueReading', JSON.stringify(list));
}

// ────────────────────────────────────────────────
// BUILD LIBRARY CARDS & ROWS
// ────────────────────────────────────────────────
function buildCard(story) {
  const imgSrc = story.heroImage || `https://via.placeholder.com/240x160/1a1a1a/cccccc?text=${encodeURIComponent(story.title.slice(0,12))}`;
  
  return `
    <div class="min-w-[200px] sm:min-w-[240px] h-[140px] sm:h-[160px] relative rounded-xl overflow-hidden card shadow-lg cursor-pointer" data-id="${story.id}">
      <img src="${imgSrc}" class="absolute inset-0 w-full h-full object-cover" alt="${story.title}">
      <div class="card-overlay absolute inset-0 flex flex-col justify-end p-4 text-shadow">
        <div class="font-bold text-sm sm:text-base line-clamp-2">${story.title}</div>
        <div class="text-xs text-gray-300 mt-1">${story.readTime || '—'}</div>
      </div>
    </div>`;
}

function buildRow(title, storyList) {
  if (!storyList?.length) return '';
  return `
    <div>
      <h2 class="text-2xl font-medium mb-4">${title}</h2>
      <div class="flex gap-4 overflow-x-auto no-scrollbar pb-4 snap-x snap-mandatory">
        ${storyList.map(buildCard).join('')}
      </div>
    </div>`;
}

function buildLibrary() {
  const library = document.getElementById('library');
  library.innerHTML = '';

  // Continue Reading
  const contIds = getContinueReading();
  const continueStories = stories.filter(s => contIds.includes(s.id))
    .sort((a,b) => contIds.indexOf(a.id) - contIds.indexOf(b.id));

  if (continueStories.length) {
    library.innerHTML += buildRow('Continue Reading', continueStories);
  }

  // Latest Stories
  const latest = [...stories].slice(0, 12);
  library.innerHTML += buildRow('Latest Stories', latest);

  // Category rows
  const categories = [...new Set(stories.map(s => s.category).filter(Boolean))];
  categories.forEach(cat => {
    const inCat = stories.filter(s => s.category === cat);
    library.innerHTML += buildRow(cat, inCat);
  });

  // Card click handlers
  document.querySelectorAll('.card').forEach(card => {
    card.addEventListener('click', () => {
      const id = card.dataset.id;
      if (id) openPlayer(id);
    });
  });
}

// ────────────────────────────────────────────────
// PLAYER MODAL
// ────────────────────────────────────────────────
function openPlayer(id) {
  const story = stories.find(s => s.id === id);
  if (!story) return;

  currentStoryId = id;
  addToContinueReading(id);

  document.getElementById('playerTitle').textContent = story.title;
  document.getElementById('playerContent').innerHTML = (story.content || '')
    .split('\n')
    .map(line => `<p class="text-lg">${line.trim()}</p>`)
    .join('');

  const pv = document.getElementById('playerVideo');
  if (story.heroVideo) {
    pv.src = story.heroVideo;
    pv.load();
    pv.play().catch(() => {});
  } else {
    pv.src = '';
  }

  // Characters from JSON
  const panel = document.getElementById('characterPanel');
  panel.innerHTML = '<h3 class="text-2xl font-serif mb-6 text-gold">Characters</h3>';

  if (story.characters?.length) {
    story.characters.forEach(char => {
      const imgSrc = char.image || `https://via.placeholder.com/300x180?text=${encodeURIComponent(char.name || '?')}`;
      panel.innerHTML += `
        <div class="bg-gray-900 rounded-xl p-4 mb-5 shadow">
          <img src="${imgSrc}" class="w-full h-48 object-cover rounded-lg mb-3" alt="${char.name || 'Character'}">
          <h4 class="text-gold font-serif text-lg">${char.name || 'Unnamed'}</h4>
          <p class="text-sm text-gray-400 mt-1">${char.description || 'No description provided'}</p>
        </div>`;
    });
  } else {
    panel.innerHTML += '<p class="text-gray-500">No character information available</p>';
  }

  document.getElementById('player').classList.remove('hidden');
}

function closePlayer() {
  document.getElementById('player').classList.add('hidden');
  const pv = document.getElementById('playerVideo');
  pv.pause();
  pv.currentTime = 0;
}

function shareReddit() {
  const story = stories.find(s => s.id === currentStoryId);
  if (!story) return;
  const title = encodeURIComponent(`A forbidden story: ${story.title}`);
  const url = encodeURIComponent(window.location.href);
  window.open(`https://www.reddit.com/submit?title=${title}&url=${url}`, '_blank');
}

// ────────────────────────────────────────────────
// HOVER VIDEO PREVIEW (optional – disabled since no card videos anymore)
// You can remove this block if you don't plan to add video previews to cards
// ────────────────────────────────────────────────

// ────────────────────────────────────────────────
// INIT
// ────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', () => {
  // Age gate
  const ageGate = document.getElementById('ageGate');
  const enterBtn = document.getElementById('enterBtn');
  const heroPlayBtn = document.getElementById('heroPlayBtn');

  if (localStorage.getItem('over18') === 'true') {
    ageGate.style.display = 'none';
  }

  if (enterBtn) {
    enterBtn.addEventListener('click', () => {
      ageGate.style.display = 'none';
      localStorage.setItem('over18', 'true');
    });
  }

  if (heroPlayBtn) {
    heroPlayBtn.addEventListener('click', () => {
      if (currentStoryId) openPlayer(currentStoryId);
    });
  }

  // Load data and build UI
  loadStories();
});
</script>
</body>
</html>
